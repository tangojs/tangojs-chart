<link rel="import" href="../polymer/polymer-element.html">

<link rel="import" href="../highcharts-chart/highcharts-chart.html">
<script src="node_modules/tangojs-web-components/dist/tangojs-web-components.js"></script>

<dom-module id="tangojs-chart">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <h2>Hello world [[prop1]]!</h2>
    <highcharts-chart
      id="chart"
      vsTime="[[trend]]"
      title='[[info.name]]'
      x-zoom
      x-label="Iterations"
      y-label="[[info.label]]"
      type="{{ type }}"
      series="[ {
                "name": "[[info.description]]",
                "borderWidth": 1,
                "data": "[[ value ]]"
	       }]"
      >
      </highcharts-chart>

  </template>

  <script>
    const DF = window.tangojs.core.tango.AttrDataFormat
    /**
     * `tangojs-chart`
     * TangoJS chart
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class TangojsChart extends tangojs.web.util.mixins.withTangoAttribute(Polymer.Element) {
      static get is() { return 'tangojs-chart'; }
      static get properties() {
        return {
          type: {
            type: String,
            value: 'spline',
	    observer: 'updateType'
          },
          trend: {
            type: Boolean,
            value: false,
	    observer: 'updateTrend'
          }
        };
      }

      infoChanged(info){
	super.infoChanged(info)
        this.updateFormatType(info)
      }

      updateFormatType(info){
        switch (info.data_format) {
          case DF.SCALAR:
	    this.setProperties({type: 'spline', trend: true})
            break
          case DF.SPECTRUM:
	    this.setProperties({type: 'spline', trend: false})
            break
          case DF.IMAGE:
	    console.warn("Image attribute is experimental")
	    this.setProperties({type: 'heatmap', trend: false})
            break
          default:
	    break
        }
      }

      updateValue(data){
        console.log(data.value)
        switch (this.info.data_format) {
          case DF.SCALAR:
	    this.$.chart.addData(data.timestamp,data.value,0,false)
            break
          case DF.SPECTRUM:
	    this.$.chart.setData(data.value)
            break

          case DF.IMAGE:
	    console.log(this.$.chart)
	    this.$.chart._chart.type = "heatmap"
	    this.$.chart.setData(data.value)
	    //this.$.chart.updateSeries("data", data.value, 0)

	    this.$.chart._chart.series = [
               {
                "name": "Sales per employee",
                "borderWidth": 1,
                "data": data.value
	       }]
            break
	    
          default: return undefined
        }
      }

      formatLayout(info){
        return { 
          "title": info.label,
          "legend": {
            "x": 0
            },
          "hovermode": "closest",
          "margin": { "b":0 }
        }
      }
    }


    window.customElements.define(TangojsChart.is, TangojsChart);
  </script>
</dom-module>
